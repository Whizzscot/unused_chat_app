<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Online Chat App</title>
        <meta charset="utf-8">
        <style>
            
            body,html{
                display:flex;
                flex-direction:column;
                align-items: center;
                margin:0px;
                padding:0px;
                min-height:100vh;
            }

            #messagebar{
                border:1px solid black;
                border-radius: 1.4em;
                position:relative;
                width:90%;
                display:flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                padding-top:0.1em;
                padding-bottom:0.1em;
                font-size: inherit;
                position:fixed;
                background-color:white;
                bottom: 3em;
            }

            #message{
                resize: none;
                line-height:1.2em;
                min-height:1.2em;
                height:1.2em;
                max-height: calc((1.2em * 4) + 0.9em + 2px);
                width:calc(100% - 5em - (3.5em * 2));
                background-color: rgba(0,0,0,0);
                padding:0.9em;
                padding-left:0px;
                outline:none;
                border:none;
                font-size: inherit;
                cursor:auto;
            }

            .bar-button{
                width:2.5em;
                height:2.5em;
                margin-left:1em;
                display:flex;
                align-items: center;
                justify-content: center;
                cursor:pointer;
                background: none;
                border: none;
            }

            .bar-button > img{
                width:inherit;
                filter: drop-shadow(2px 2px 2px black);
                -webkit-filter: drop-shadow(2px 2px 2px black);
            }

            .bar-button > img:hover{
                filter: brightness(0.1) invert(0.30) sepia(.5) hue-rotate(160deg) saturate(600%) drop-shadow(2px 2px 2px black);
                -webkit-filter: brightness(0.1) invert(0.30) sepia(.5) hue-rotate(160deg) saturate(600%) drop-shadow(2px 2px 2px black);
            }

            /* width */
            ::-webkit-scrollbar {
                width: 10px;
            }

            /* Track */
            ::-webkit-scrollbar-track {
                background: #f1f1f1;
            }

            /* Handle */
            ::-webkit-scrollbar-thumb {
                background: #888;
            }

            /* Handle on hover */
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

            @media(pointer:coarse){
                @media(orientation:landscape){
                    #message{
                        max-height: calc((1.2em * 2) + 0.9em + 2px);
                    }
                }

                @media(orientation:portrait){
                    body{
                        font-size:1cm;
                    }

                    #message{
                        width:calc(100% - 5em - (2.5em * 2));
                    }

                    .bar-button{
                        width:5em;
                        height:5em;
                        margin-left:2em;
                    }
                }

                #messagebar{
                    border-radius: 1.6em;
                    bottom:1em;
                }

            }

            .popup-background{
                position:fixed;
                background-color: rgba(0,0,0,0.5);
                width:100vw;
                height:100vh;
                top:0px;
                left:0px;
                z-index:3;
                display:flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .popup{
                max-width:100vw;
                max-height:100vh;
            }
        </style>
        <script src="socket.io/socket.io.min.js"></script>
        <script>
            const touchscreen = window.matchMedia("(pointer:coarse)").matches;

            function getCookie(name){
                let cookies = document.cookie.split("; ")
                for(let c = 0; c < cookies.length; ++c){
                    let CNV = cookies[c].split("=");
                    if(CNV[0]===name) return CNV[1];
                }
            };

            function setCookie(cname, cvalue, exdays) {
                const d = new Date();
                d.setTime(d.getTime() + (exdays*24*60*60*1000));
                let expires = "expires="+ d.toUTCString();
                document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
            };

            const socket = io({
                auth:{token: getCookie("token")||""}
            });

            document.addEventListener("contextmenu",e=>{
                e.preventDefault();
                return false;
            });
        </script>
    </head>
    <body>
        <h1>Main Page</h1>
        <div id="messages-wrapper">

        </div>
        <div id="messagebar">
            <textarea id="message" placeholder="Type Message Here..."></textarea>
            <button class="bar-button"><img src="images/send.png" id="send-button"></button>
            <button class="bar-button"><img src="images/cog.png" id="settings-button"></button>
        </div>
        <script>
            const MessageEl = document.getElementById("message");

            function updateHeight(){
                MessageEl.style.height = "0px";
                let styleData = window.getComputedStyle(MessageEl,null);
                let lineHeight = parseFloat(styleData.getPropertyValue('line-height').slice(0,-2));
                let padding = 
                    parseFloat(styleData.getPropertyValue('padding-top').slice(0,-2)) +
                    parseFloat(styleData.getPropertyValue('padding-bottom').slice(0,-2));
                ;
                MessageEl.style.height = (MessageEl.scrollHeight-padding+1)+"px";
            }

            function sendMessage(content){
                if(content) socket.emit("message",{
                    content,
                    sent:Date.now(),
                });
                MessageEl.value = "";
                updateHeight();
            };

            MessageEl.addEventListener("keydown",e=>{
                if(e.key != "Enter" || e.shiftKey || touchscreen) return;
                e.preventDefault();
                e.stopPropagation();
                sendMessage(MessageEl.value);
                return false;
            });

            MessageEl.addEventListener("input", updateHeight);

            document.getElementById("send-button").addEventListener("click",()=>{
                sendMessage(MessageEl.value);
                MessageEl.focus();
            });

            window.addEventListener("resize", updateHeight);
        </script>
    </body>
</html>